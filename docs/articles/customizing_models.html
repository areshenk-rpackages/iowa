<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="iowa">
<title>Adding new models • iowa</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Adding new models">
<meta property="og:description" content="iowa">
<meta property="og:image" content="areshenk-rpackages.github.io/iowa/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light" data-bs-theme="light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">iowa</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <h6 class="dropdown-header" data-toc-skip>Models</h6>
    <a class="dropdown-item" href="../articles/model_structure.html">Model structure</a>
    <a class="dropdown-item" href="../articles/utility_functions.html">Utility functions</a>
    <a class="dropdown-item" href="../articles/updating_functions.html">Updating functions</a>
    <a class="dropdown-item" href="../articles/temperature_functions.html">Temperature functions</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Tutorials</h6>
    <a class="dropdown-item" href="../articles/deck_structure.html">Deck structure</a>
    <a class="dropdown-item" href="../articles/simulation_guide.html">Simulating IGT data</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Adding to iowa</h6>
    <a class="dropdown-item" href="../articles/customizing_decks.html">Adding new decks</a>
    <a class="dropdown-item" href="../articles/customizing_models.html">Adding new models</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Adding new models</h1>
                        <h4 data-toc-skip class="author">Corson N.
Areshenkoff</h4>
            
            <h4 data-toc-skip class="date">2024-07-27</h4>
      
      
      <div class="d-none name"><code>customizing_models.Rmd</code></div>
    </div>

    
    
<p>Adding new model components (e.g. new utility functions) involves two
broad steps:</p>
<ul>
<li>Making the component available to RStan, which is responsible for
all model simulation and fitting.</li>
<li>Updating <strong>iowa</strong>’s internal information about the
model component, including parameter names, bounds, etc.</li>
</ul>
<p>Although the actual process of adding a new component is slightly
tedious, the ultimate goal is that, once added, the new component can be
used with all package functions (and combined with all other components)
with a minimum of thought or fuss.</p>
<div class="section level3">
<h3 id="internal-package-structure">Internal package structure<a class="anchor" aria-label="anchor" href="#internal-package-structure"></a>
</h3>
<p>The general structure of the package is as follows:</p>
<ul>
<li>The wrapper functions <code><a href="../reference/simulateIGT.html">simulateIGT()</a></code> and
<code><a href="../reference/fitIGT.html">fitIGT()</a></code> provide a high-level interface to the underlying
stan code, which implements the model fitting and simulation
procedures.</li>
<li>
<code>.stan</code> files implement the general model.</li>
<li>The actual component functions (e.g. the specific utility function)
are passed internally as data to the stan model, which are then imported
from a separate <code>.stan</code> file. These separate files are stored
in <code>inst/stan/include</code>, with the names e.g.
<code>utilityFunctions.stan</code>.</li>
</ul>
<p>For example, <code>inst/stan/fitIGT.stan</code> – which is
responsible for model fitting – specifies a general model as
follows:</p>
<pre><code>// Likelihood
for (t in 1:NUM_TRIALS){

    // Compute temperature
    theta = temperature(t, temperature_params, TEMPERATURE_FUNCTION);

    // Draw card
    choice[t] ~ categorical_logit(theta * V);

    // Compute utility
    U = utility(win[t], loss[t], utility_params, UTILITY_FUNCTION);

    // Update deck values
    V = updating(V, U, choice[t], updating_params, UPDATING_FUNCTION);
}</code></pre>
<p>On trial <code>t</code>, the utility of the outcome is evaluated
through the function</p>
<pre><code><span><span class="fu">utility</span><span class="op">(</span><span class="va">win</span><span class="op">[</span><span class="va">t</span><span class="op">]</span>, <span class="va">loss</span><span class="op">[</span><span class="va">t</span><span class="op">]</span>, <span class="va">utility_params</span>, <span class="va">UTILITY_FUNCTION</span><span class="op">)</span>;</span></code></pre>
<p>where <code>utility</code> is imported from
<code>inst/stan/include/utilityWrapper.stan</code>, and is defined
by</p>
<pre><code>real utility(real win, real loss, real[] par, int ind){

    if (ind == 1){
        return utility_EU(win, loss, par);
    } else if (ind == 2){
        return utility_PU(win, loss, par);
    } else if (ind == 3){
        return utility_PU2(win, loss, par);
    } else {
        return 0;
    }
}</code></pre>
<p>Note that this function is just a general wrapper that calls one of
several utility functions depending on the integer argument
<code>ind</code>. In turn, all utility functions are defined in
<code>inst/stan/include/utilityFunctions.stan</code>.</p>
<p>As an example, the EU and PU utility are defined by:</p>
<pre><code>// EU utility function (used in EV model)
real utility_EU(real win, real loss, real[] par) {
    return (1-par[1]) * win - par[1] * loss;
}

// Prospect utility function
real utility_PU(real win, real loss, real[] par) {
    real net = win - loss;
    if (net &gt;= 0){
        return pow(net, par[1]);
    } else {
        return -par[2] * pow(fabs(net), par[1]);
    }
}</code></pre>
<p>Note an important point: <strong>All utility functions have exactly
the same signature</strong>; that is
<code>real win, real loss, real[] par</code>.</p>
<p>When the user specifies a utility function as an argument to
something like <code><a href="../reference/fitIGT.html">fitIGT()</a></code>, the package first loads a
<code>modelDetails</code> object contained in
<code>R/sysdata.rda</code>. This structure is a nested list containing
information about each model component; such as its required parameters,
and any necessary (or default) bounds.</p>
<p>The structure of this list is as follows:</p>
<pre><code>modelDetails
.  utility
. .  EU
. . .  w
. . . .  bounds = c(0,1)
. . . .  default_bounds = c(0, 1)
. . . .  description = "Win/loss weighting"
. .  PU
. . .  A
. . . .  bounds = c(0, Inf)
. . . .  default_bounds = c(0, 1)
. . . .  description = "Concavity of utility function"
. . .  L
. . . .  bounds = c(0, Inf)
. . . .  default_bounds = c(0, 5)
. . . .  description = "Loss aversion"

&lt;break&gt;

.  updating
. .  DRL
. . .  d
. . . .  bounds = c(0, 1)
. . . .  default_bounds =  c(0, 1)
. . . .  description = "Decay parameter"</code></pre>
<p>That is, it has fields <code>utility</code>, <code>updating</code>,
and <code>temperature</code>; each of which is a named list with fields
corresponding to each included function. Each of these fields in turn
has a field for each parameter, which then contains entries giving
parameter bounds (outside of which the package will throw an error), as
well as default bounds used for model fitting if the user does not
specify their own.</p>
<p>Note that the order of utility functions in this list corresponds to
the order in which they are called in <code>utilityWrapper.stan</code>.
Thus, when the user specifies <code>utility = 'PU'</code>, the package
matches this to the second utility function in
<code>modelDetails</code>, passes the argument <code>2</code> as data to
Stan, which passes it to <code>utility()</code>, which in turn calls
<code>utility_PU()</code>.</p>
<p>The general structure of the R/Stan program is illustrated below,
using the utility function as an example:</p>
<p><img src="figures/stan_diagram.png" width="622" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="implementing-a-new-model-component">Implementing a new model component<a class="anchor" aria-label="anchor" href="#implementing-a-new-model-component"></a>
</h3>
<p>Adding a new utility function to <strong>iowa</strong> now involves
the following steps:</p>
<ol style="list-style-type: decimal">
<li>Add the function to
<code>inst/stan/include/utilityFunctions.stan</code>, making sure that
it matches the required signature.</li>
<li>Add a new <code>if</code> statement to
<code>inst/stan/include/utilityWrapper.stan</code>, corresponding to the
next highest value of <code>ind</code>.</li>
<li>Add a new field to <code>modelDetails</code> in the
<code>utility</code> field – named with the unique keyword of the new
utility function – and populate it with the necessary fields (i.e. one
subfield for each parameter, each with the required fields
<code>bounds</code> and <code>default_bounds</code>). The position of
this new field in <code>modelDetails$utility</code> must correspond to
the value of <code>ind</code> which calls the new utility function in
step (2).</li>
<li>Resave <code>modelDetails</code> to <code>R/sysdata.rda</code> using
<code>save(modelDetails, file = 'R/sysdata.rda')</code>.</li>
</ol>
<p>After the package is recompiled, the new utility function should be
ready for use.</p>
<p>The steps for adding new updating or temperature functions are
essentially identical, <em>mutatis mutandis</em>.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://areshenk.github.io/" class="external-link"><img src="https://areshenk.github.io/about/sidebar/avatar.jpg" width="72"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
